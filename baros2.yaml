# =============================================================================
# 智能调酒系统 - ESP32主控板配置文件
# 功能: 调酒控制、水箱监控、LED控制、主机通信
# 架构: 主从模式，支持串口通信协议
# =============================================================================

esphome: 
  name: baros
  project:
    name: baros-main
    version: "2025.11.10.1"   # must match your current firmware version

  on_boot:
    - priority: -100.0
      then:
        - binary_sensor.template.publish:
            id: pouring
            state: false
        - light.turn_on: led_rgb1
update: 
  - platform: http_request
    id: fw_update
    name: "Firmware Update"
    source: "waiting_for_update"????
    on_update_available:
      then:
        - logger.log: "New firmware available, starting OTA!"
        - update.perform: fw_update


external_components:
  - source:
      type: git
      url: https://github.com/miceno/esphome-http_request
      ref: fix/infinite-loop
    components: [ http_request ]
    refresh: 1s

# ================================= ============================================
# 硬件平台配置
# =============================================================================
esp32:
  board: esp32-s3-devkitc-1
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    version: recommended
psram: 
  mode: octal
  speed: 80MHz
# =============================================================================
# 日志配置
# =============================================================================
logger:
  # level: INFO
  logs:
    fan: NONE
    switch: ERROR
    binary_sensor: INFO
    script: INFO
    http_request: NONE
# =============================================================================
# HTTP请求配置
# =============================================================================
http_request:
  verify_ssl: false
  watchdog_timeout: 10s
  timeout: 3s

# =============================================================================
# 全局变量定义
# =============================================================================
globals:
  - id: LIQUID_POURING
    type: bool
    initial_value: 'false'

  - id: TEMP_NUM
    type: int
    initial_value: '0'

  - id: host_reply_received    # 主机通信回复标志
    type: bool
    initial_value: 'false'


  - id: RECIPE_WINE_VOLUME
    type: float[7]
    initial_value: '{0, 0, 0, 0, 0, 0, 0}'
  - id: RECIPE_TANK_ORDER
    type: int[7]
    initial_value: '{0, 0, 0, 0, 0, 0, 0}'

  - id: RECIPE_READY
    type: bool
    initial_value: 'false'


# 泵速度（mL/s)
  - id: PUMP_SPEED
    type: float
    initial_value: '2.1'

# 水箱1到出口的延迟时间（秒）
  - id: TANK1_DELAY
    type: float
    initial_value: '2.5'

# 水箱2到出口的延迟时间（秒）
  - id: TANK2_DELAY
    type: float
    initial_value: '2.5'
# 水箱3到出口的延迟时间（秒）
  - id: TANK3_DELAY
    type: float
    initial_value: '6'
# 水箱4到出口的延迟时间（秒）
  - id: TANK4_DELAY
    type: float
    initial_value: '6'
# 水箱5到出口的延迟时间（秒）
  - id: TANK5_DELAY
    type: float
    initial_value: '6'
# 水箱6到出口的延迟时间（秒）
  - id: TANK6_DELAY
    type: float
    initial_value: '9'
# 水箱7到出口的延迟时间（秒）
  - id: TANK7_DELAY
    type: float
    initial_value: '9'


# 在水管充斥前，水箱的初始流量
  - id: TANK1_INITIAL_SPEED
    type: float
    initial_value: '1.4'
  - id: TANK2_INITIAL_SPEED
    type: float
    initial_value: '1.2'
  - id: TANK3_INITIAL_SPEED
    type: float
    initial_value: '2.6'
  - id: TANK4_INITIAL_SPEED
    type: float
    initial_value: '2.4'
  - id: TANK5_INITIAL_SPEED
    type: float
    initial_value: '2.5'
  - id: TANK6_INITIAL_SPEED
    type: float
    initial_value: '2.55'
  - id: TANK7_INITIAL_SPEED
    type: float
    initial_value: '3.2'
    
# 在水管充斥前，需要多少秒
  - id: TANK1_INITIAL_SPEED_DURATION
    type: float
    initial_value: '3.5'
  - id: TANK2_INITIAL_SPEED_DURATION
    type: float
    initial_value: '6.5'
  - id: TANK3_INITIAL_SPEED_DURATION
    type: float
    initial_value: '3'
  - id: TANK4_INITIAL_SPEED_DURATION
    type: float
    initial_value: '4'
  - id: TANK5_INITIAL_SPEED_DURATION
    type: float
    initial_value: '4'
  - id: TANK6_INITIAL_SPEED_DURATION
    type: float
    initial_value: '4'
  - id: TANK7_INITIAL_SPEED_DURATION
    type: float
    initial_value: '3'


# =============================================================================
# 网络配置
# =============================================================================
wifi:  
  networks:
    - ssid: "Latent Spice"
      password: "bqsj123456"
    - ssid: "bqsj-nono"
      password: "Qzpm!234.."
  fast_connect: true
  power_save_mode: none

# =============================================================================
# OTA更新配置 Web服务器配置
# =============================================================================
ota: 
  - platform: esphome
  - platform: web_server
  - platform: http_request
web_server: 
  port: 80
  version: 3
  local: true
  sorting_groups:
# =============================================================================
# 主从通信配置 (与从机ESP32通信)
# =============================================================================
packet_transport:
  - platform: uart
    uart_id: uart_com
    update_interval: 1s
    binary_sensors:
      - pouring
# =============================================================================
# 串口通信配置
# =============================================================================
uart:
  - id: uart_com        # 与从机通信串口 (GPIO17/18)
    tx_pin: 17
    rx_pin: 18
    baud_rate: 115200
  

# =============================================================================
# 传感器配置
# =============================================================================
sensor:
  # 水泵电压监测
  - platform: adc
    name: Water Pump Voltage
    id: pump_V
    pin: 6
  # 电解模块电压监测
  - platform: adc
    name: O3 Voltage
    id: o3_V
    pin: 8

 # NTC温度传感器
  - platform: ntc
    sensor: resistance_sensor
    calibration:
      b_constant: 3950
      reference_temperature: 25°C
      reference_resistance: 10kOhm
    name: NTC Temperature

  # Example source sensors:
  - platform: resistance
    id: resistance_sensor
    sensor: source_sensor
    configuration: DOWNSTREAM
    resistor: 20kOhm
    reference_voltage: 5V
    name: Resistance Sensor

  - platform: adc
    id: source_sensor
    pin: 15
    update_interval: 1s
    attenuation: 12db
# =============================================================================
# 数字输入配置 (滑轨控制器)
# =============================================================================

number:
  - platform: template
    name: "泵1运行时间"
    id: pump1_duration
    min_value: 1
    max_value: 15
    step: 0.1
    unit_of_measurement: "秒"
    mode: box
    optimistic: true
    initial_value: 5.0

# =============================================================================
# 按钮配置 (泵1控制)
# =============================================================================
button:
  - platform: restart
    name: "restart"
    id: restart_button

  - platform: template
    name: "启动泵1"
    id: start_pump1
    on_press:
      then:
        - logger.log: "泵1滑轨控制启动"
        - lambda: |-
            float duration = id(pump1_duration).state;
            ESP_LOGI("pump1", "启动泵1，速度100%，运行%.1f秒", duration);
        - fan.turn_on:
            id: pump1
            speed: 45
        - lambda: |-
            float duration = id(pump1_duration).state;
            ESP_LOGI("pump1", "泵1运行中，等待%.1f秒", duration);
        - delay: !lambda 'return id(pump1_duration).state * 1000;'
        - lambda: |-
            ESP_LOGI("pump1", "关闭泵1");
        - fan.turn_off: pump1
        - logger.log: "泵1滑轨控制完成"
  - platform: template
    name: "测试泵和水箱距离"
    on_press:
      then:
        - fan.turn_on:
            id: pump1
            speed: 45
        - wait_until:
            condition:
              - binary_sensor.is_on: liquid1
            timeout: 15s
        - lambda: |-
            float duration = id(pump1_duration).state;
            ESP_LOGI("pump1", "泵1运行中，等待%.1f秒", duration);
        - delay: !lambda 'return id(pump1_duration).state * 1000;'
        - fan.turn_off: pump1

# =============================================================================
# 开关控制配置
# =============================================================================
switch:
  - platform: template
    name: STOP_POST
    id: STOP_POST
    optimistic: true

  - platform: template
    name: 水泵
    id: water_pump
    lambda: !lambda "return id(water_pump_slave).state;"
    turn_on_action:
      - lambda: !lambda "return id(water_pump_slave).publish_state(true);"
    turn_off_action:
      - lambda: !lambda "return id(water_pump_slave).publish_state(false);"
      
  - platform: template
    name: Valve 1
    id: valve1
    lambda: !lambda "return id(valve1_slave).state;"
    turn_on_action:
      - lambda: !lambda "return id(valve1_slave).publish_state(true);"
    turn_off_action:
      - lambda: !lambda "return id(valve1_slave).publish_state(false);"

  - platform: template
    name: Valve 2
    id: valve2
    lambda: !lambda "return id(valve2_slave).state;"
    turn_on_action:
      - lambda: !lambda "return id(valve2_slave).publish_state(true);"
    turn_off_action:
      - lambda: !lambda "return id(valve2_slave).publish_state(false);"



  # 主继电器控制
  - platform: gpio
    pin:
      number: 4
      mode:
        output: true
        pulldown: true
    name: 24V Relay
    internal: true
    id: relay

  # 电解模块开关 (GPIO40/42联动控制)
  # - platform: gpio
  #   pin: 48
  #   name: O3 Enable
  #   id: o3_en


 
  # 调酒泵控制信号
  - platform: gpio
    pin: 2
    name: Pump1_Reverse 泵反转
    id: pump1_reverse
    
  - platform: gpio
    pin: 41
    name: Pump2_Reverse 泵反转
    id: pump2_reverse

  - platform: gpio
    pin: 39
    name: Pump3_Reverse 泵反转
    id: pump3_reverse
    # restore_mode: ALWAYS_ON

  - platform: gpio
    pin: 48
    name: Pump4_Reverse 泵反转
    id: pump4_reverse
  - platform: gpio
    pin: 21
    name: Pump5_Reverse 泵反转
    id: pump5_reverse   
  - platform: gpio
    pin: 13
    name: Pump6_Reverse 泵反转
    id: pump6_reverse   
  - platform: gpio
    pin: 11
    name: Pump7_Reverse 泵反转
    id: pump7_reverse   
  - platform: gpio
    pin: 9
    name: Pump8_Reverse 泵反转
    id: pump8_reverse   



# =============================================================================
# 二进制传感器配置 (从机数据接收)
# =============================================================================
binary_sensor:
  # 水箱状态传感器 (8个水箱，带自动状态通知)
  - platform: packet_transport
    provider: baros-slave
    remote_id: tank1_slave
    id: tank1
    name: Tank1
    internal: false
  - platform: packet_transport
    provider: baros-slave
    remote_id: tank2_slave
    id: tank2
    name: Tank2
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank3_slave
    id: tank3
    name: Tank3 
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank4_slave
    id: tank4
    name: Tank4
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank5_slave
    id: tank5
    name: Tank5
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank6_slave
    id: tank6
    name: Tank6
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank7_slave
    id: tank7
    name: Tank7
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: tank8_slave
    id: tank8
    name: Tank8
    internal: false

  # 液位状态传感器 (7个液位传感器)
  - platform: packet_transport
    provider: baros-slave
    remote_id: liquid1_slave
    id: liquid1
    name: Liquid1
    internal: false
  - platform: packet_transport
    provider: baros-slave
    remote_id: liquid2_slave
    id: liquid2
    name: Liquid2
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: water_pump_slave_sensor
    id: water_pump_slave
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: valve1_slave_sensor
    id: valve1_slave
    internal: false

  - platform: packet_transport
    provider: baros-slave
    remote_id: valve2_slave_sensor
    id: valve2_slave
    internal: false

  # 通知辅MCU 告诉树莓派出酒状态
  - platform: template
    name: Recipe Running
    id: pouring
    condition:
      for:
        time: 1s
        condition:
          lambda: |-
            if(id(LIQUID_POURING)){
              return true;
            } else {
              return false;
            }
  - platform: packet_transport
    provider: baros-slave
    remote_id: clean_system_slave
    id: clean_system_sensor
    name: Clean System
    internal: false
    on_press:
      then:
        - script.execute: clean_system

  - platform: packet_transport
    provider: baros-slave
    remote_id: pi_started_slave
    id: pi_started
    name: PI Started
    internal: false
    on_press:
      then:
        - light.turn_on: led_rgb1
# =============================================================================
# LED控制配置
# =============================================================================
light:
  # LED灯板 (状态指示) - 4个LED，自定义时序
  - platform: esp32_rmt_led_strip
    id: led_rgb1
    name: "LED Button"
    rgb_order: GRB
    pin: 7
    num_leds: 4
    chipset: WS2812
    on_turn_on:
      - light.turn_on:
          id: led_rgb1
          red: 0.598
          green: 0.688
          blue: 1.0
          brightness: 1.0


# =============================================================================
# PWM输出配置 (调酒泵控制)
# =============================================================================
output:
  - platform: ledc
    id: pump1_output
    frequency: 800Hz
    pin: 1

  - platform: ledc
    id: pump2_output
    frequency: 800Hz
    pin: 42

  - platform: ledc
    id: pump3_output
    frequency: 800Hz
    pin: 40

  - platform: ledc
    id: pump4_output
    frequency: 800Hz
    pin: 38

  - platform: ledc
    id: pump5_output
    frequency: 800Hz
    pin: 47

  - platform: ledc
    id: pump6_output
    frequency: 800Hz
    pin: 14

  - platform: ledc
    id: pump7_output
    frequency: 800Hz
    pin: 12

  - platform: ledc
    id: pump8_output
    frequency: 800Hz
    pin: 10

# =============================================================================
# 风扇/泵控制配置
# =============================================================================
fan: 
  - platform: speed
    output: pump1_output
    name: Pump1 泵正转
    id: pump1

  - platform: speed
    output: pump2_output
    name: Pump2 泵正转
    id: pump2

  - platform: speed
    output: pump3_output
    name: Pump3 泵正转
    id: pump3
    # restore_mode: ALWAYS_ON

  - platform: speed
    output: pump4_output
    name: Pump4 泵正转
    id: pump4
  - platform: speed
    output: pump5_output
    name: Pump5 泵正转
    id: pump5
  - platform: speed
    output: pump6_output
    name: Pump6 泵正转
    id: pump6
  - platform: speed
    output: pump7_output
    name: Pump7 泵正转
    id: pump7
  - platform: speed
    output: pump8_output
    name: Pump8 泵正转
    id: pump8
# =============================================================================
# 脚本配置 (核心业务逻辑)
# =============================================================================
script:
  # 统一倒酒函数 (支持8个阀门，可调时间)
  - id: pour_liquid
    parameters:
      tank_num: int
      volume: float
    mode: queued
    then:
      - globals.set:
          id: LIQUID_POURING
          value: 'true'
      - logger.log: "开始倒酒: 阀门${tank_num}, 时长${duration}秒"
      # 根据阀门编号选择对应阀门
      - lambda: |-
          ESP_LOGI("pour", "开启阀门%d", tank_num);
          auto call = id(pump1).turn_on();
          // switch(tank_num) {
          //   case 1:
          //     auto call = id(pump1).turn_on();
          //     break;
          //   case 2:
          //     auto call = id(pump2).turn_on();
          //     break;
          //   case 3:
          //     auto call = id(pump3).turn_on();
          //     break;
          //   case 4:
          //     auto call = id(pump4).turn_on();
          //     break;
          //   case 5:
          //     auto call = id(pump5).turn_on();
          //     break;
          //   case 6:
          //     auto call = id(pump6).turn_on();
          //     break;
          //   case 7:
          //     auto call = id(pump7).turn_on();
          //     break;
          //   case 8:
          //     auto call = id(pump8).turn_on();
          //     break;
          //   default:
          //     return true;
          // }
          call.perform();
      - delay: 0.5s
      - lambda: |-
          ESP_LOGI("pour", "启动泵,速度45%");
      - fan.turn_on:
          id: pump1
          speed: 45
      - logger.log: "等待液位传感器"
      - wait_until:
          condition:
            lambda: |-
              switch(tank_num) {
                case 1:
                  return id(liquid1).state == true;
                  break;
                case 2:
                  return id(liquid2).state == true;
                  break;
                default:
                  ESP_LOGW("pour", "无效的阀门号: %d", tank_num);
                  return false;
              }
          timeout: 10s
      - delay: !lambda |-
          float v = 0;
          float t = 0;
          switch(tank_num) {
            case 1:
              v = id(TANK1_INITIAL_SPEED_DURATION) * id(TANK1_INITIAL_SPEED);
              if(volume <= v) {
                t = id(TANK1_DELAY) + ( volume / id(TANK1_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK1_DELAY) + id(TANK1_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 2:
              v = id(TANK2_INITIAL_SPEED_DURATION) * id(TANK2_INITIAL_SPEED);
              if(volume <= v) {
                t = id(TANK2_DELAY) + ( volume / id(TANK2_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK2_DELAY) + id(TANK2_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 3:
              v = id(TANK3_INITIAL_SPEED_DURATION) * id(TANK3_INITIAL_SPEED);
              if(volume < v) {
                t = id(TANK3_DELAY) + ( volume / id(TANK3_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK3_DELAY) + id(TANK3_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 4:
              v = id(TANK4_INITIAL_SPEED_DURATION) * id(TANK4_INITIAL_SPEED);
              if(volume <= v) {
                t = id(TANK4_DELAY) + ( volume / id(TANK4_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK4_DELAY) + id(TANK4_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 5:
              v = id(TANK5_INITIAL_SPEED_DURATION) * id(TANK5_INITIAL_SPEED);
              if(volume < v) {
                t = id(TANK5_DELAY) + ( volume / id(TANK5_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK5_DELAY) + id(TANK5_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 6:
              v = id(TANK6_INITIAL_SPEED_DURATION) * id(TANK6_INITIAL_SPEED);
              if(volume <= v) {
                t = id(TANK6_DELAY) + ( volume / id(TANK6_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK6_DELAY) + id(TANK6_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            case 7:
              v = id(TANK7_INITIAL_SPEED_DURATION) * id(TANK7_INITIAL_SPEED);
              if(volume <= v) {
                t = id(TANK7_DELAY) + ( volume / id(TANK7_INITIAL_SPEED));
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              } else {
                t = id(TANK7_DELAY) + id(TANK7_INITIAL_SPEED_DURATION) + (volume - v) / id(PUMP_SPEED);
                ESP_LOGI("pour", "等待 %.1f 秒", t);
                return 1000*t;
              }
              break;
            default:
              ESP_LOGW("pour", "无效的阀门号: %d", tank_num);
              return 0;
          }   
      - logger.log: "关闭泵"
      - fan.turn_off: pump1
      - delay: 0.5s
      - globals.set:
          id: TEMP_NUM
          value: !lambda "return tank_num;"
      # 泵反转，液体回流
      - switch.turn_on: pump1_reverse
      - delay: 3.5s
      # - wait_until:
      #     condition:
      #       for:
      #         time: 1.5s
      #         condition: 
      #           lambda: |-
      #             switch (id(TEMP_NUM)) {
      #               case 1: return !id(liquid1).state;
      #               case 2: return !id(liquid2).state;
      #               case 3: return !id(liquid3).state;
      #               case 4: return !id(liquid4).state;
      #               case 5: return !id(liquid5).state;
      #               case 6: return !id(liquid6).state;
      #               case 7: return !id(liquid7).state;
      #               default: return false;
      #             }
      #     timeout: 6s
      - switch.turn_off: pump1_reverse
      - script.execute: turn_off_all_valves
      - script.wait: turn_off_all_valves
      - globals.set:
          id: LIQUID_POURING
          value: 'false'
      - logger.log: "Recipe倒酒完成"

  - id: turn_off_all_valves
    mode: restart
    then:
      - logger.log: "关闭所有阀门"
      # - switch.turn_off: pump1    
      # - switch.turn_off: pump2

  - id: turn_on_all_valves
    mode: restart
    then:
      - switch.turn_on: valve1
      - switch.turn_on: valve2

  # LED灯带颜色脚本 (15种预设颜色)
  # - id: led_strip_color
  #   parameters:
  #     color: int
  #   mode: single
  #   then:
  #     # - logger.log: "LED灯带颜色: ${color}"
      
  #     # 根据颜色编号设置LED颜色
  #     - lambda: |-
  #         switch(color) {
  #           case 0: // 红色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(0.0).set_blue(0.0);
  #             break;
  #           case 1: // 绿色
  #             id(led_rgb2).turn_on().set_red(0.0).set_green(1.0).set_blue(0.0);
  #             break;
  #           case 2: // 蓝色
  #             id(led_rgb2).turn_on().set_red(0.0).set_green(0.0).set_blue(1.0);
  #             break;
  #           case 3: // 黄色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(1.0).set_blue(0.0);
  #             break;
  #           case 4: // 紫色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(0.0).set_blue(1.0);
  #             break;
  #           case 5: // 青色
  #             id(led_rgb2).turn_on().set_red(0.0).set_green(1.0).set_blue(1.0);
  #             break;
  #           case 6: // 橙色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(0.5).set_blue(0.0);
  #             break;
  #           case 7: // 粉色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(0.2).set_blue(0.5);
  #             break;
  #           case 8: // 白色
  #             id(led_rgb2).turn_on().set_red(1.0).set_green(1.0).set_blue(1.0);
  #             break;
  #           case 9: // 其他颜色1
  #           case 10:
  #           case 11:
  #           case 12:
  #           case 13:
  #           case 14:
  #             id(led_rgb2).turn_on().set_red(0.8).set_green(0.6).set_blue(0.4);
  #             break;
  #           default:
  #             ESP_LOGW("led", "无效的颜色号: %d", color);
  #             break;
  #         }
      
  #     - logger.log: "LED灯带颜色设置完成"

  # LED灯带效果脚本 (10种动态效果)
  # - id: led_strip_effect
  #   parameters:
  #     effect: int
  #   mode: single
  #   then:
      # - logger.log: "LED灯带效果: ${effect}"
      
      # 根据效果编号执行LED效果
      # - lambda: |-
      #     switch(effect) {
      #       case 0: // 常亮
      #         ESP_LOGI("led", "执行效果0: 常亮");
      #         id(led_rgb2).turn_on().set_brightness(1.0);
      #         break;
      #       case 1: // 呼吸灯
      #         ESP_LOGI("led", "执行效果1: 呼吸灯");
      #         // 呼吸灯效果需要循环，这里先设置基础亮度
      #         id(led_rgb2).turn_on().set_brightness(0.6);
      #         break;
      #       case 2: // 闪烁
      #         ESP_LOGI("led", "执行效果2: 闪烁");
      #         // 闪烁效果需要循环，这里先设置基础亮度
      #         id(led_rgb2).turn_on().set_brightness(1.0);
      #         break;
      #       case 3: // 流动
      #         ESP_LOGI("led", "执行效果3: 流动");
      #         // 流动效果需要循环，这里先设置红色
      #         id(led_rgb2).turn_on().set_red(1.0).set_green(0.0).set_blue(0.0);
      #         break;
      #       case 4: // 彩虹
      #         ESP_LOGI("led", "执行效果4: 彩虹");
      #         // 彩虹效果需要循环，这里先设置红色
      #         id(led_rgb2).turn_on().set_red(1.0).set_green(0.0).set_blue(0.0);
      #         break;
      #       case 5: // 自定义效果1
      #       case 6: // 自定义效果2
      #       case 7: // 自定义效果3
      #       case 8: // 自定义效果4
      #         ESP_LOGI("led", "执行效果%d: 自定义效果", effect);
      #         id(led_rgb2).turn_on().set_brightness(0.8);
      #         break;
      #       case 9: // 关闭
      #         ESP_LOGI("led", "执行效果9: 关闭");
      #         break;
      #       default:
      #         ESP_LOGW("led", "无效的效果号: %d", effect);
      #         break;
      #     }
      
      # - logger.log: "LED灯带效果完成"


  # 系统清洗脚本 (电解模块+8个阀门清洗)
  - id: clean_system
    mode: single
    then:
      - logger.log: "开始清洗系统"
      # - switch.turn_on: o3_en
      # - delay: 0.5s
      # 同时开启所有阀门
      - repeat:
          count: 7
          then:
            # - script.execute: turn_on_all_valves
            # - script.wait: turn_on_all_valves
            - delay: 0.2s
            - lambda: |-
                switch(iteration+1) {
                  case 1: id(valve1).turn_off();break;
                  case 2: id(valve2).turn_off();break;
                  default: break;
                }
            - delay: 0.2s
            - switch.turn_on: water_pump
            - delay: 5.0s
            - switch.turn_off: water_pump
      # 排水，引入空气
      # - switch.turn_on: valve8
      - repeat:
          count: 7
          then:
            - script.execute: turn_on_all_valves
            - script.wait: turn_on_all_valves
            - delay: 0.2s
            - lambda: |-
                switch(iteration+1) {
                  case 1: id(valve1).turn_off();break;
                  case 2: id(valve2).turn_off();break;
                  default: break;
                }
            - delay: 0.2s
            - switch.turn_on: water_pump
            - delay: 8s
            - switch.turn_off: water_pump
      - logger.log: "系统清洗完成"
      - binary_sensor.template.publish:
          id: clean_system_sensor
          state: false
      # 通知主机自清洗结束
      # - script.execute:
      #     id: send_to_host
      #     module: 0x00
      #     data1: 0x01
      #     data2: 0x00

  # =============================================================================
  # 配方管理脚本
  # =============================================================================
  
  # 获取配方并缓存到数组
  - id: get_recipe
    mode: single
    then:
      - http_request.post:
          url: https://breakreal.top/langgraph-server/drink/test-demo-get-machine-task-with-idx
          request_headers:
            Content-Type: application/json
          json:
            machine_id: "lizi-001"
          capture_response: true
          max_response_buffer_size: 3 kB
          on_response:
            then:
              - if:
                  condition:
                      lambda: return response->status_code == 200;
                  then:
                    - logger.log:
                        format: 'Response status: %d, Duration: %u ms'
                        args:
                          - response->status_code
                          - response->duration_ms
                    # 清零 
                    - lambda: |-
                        size_t size = sizeof(id(RECIPE_WINE_VOLUME)) / sizeof(id(RECIPE_WINE_VOLUME)[0]);
                        for (size_t i = 0; i < size; i++) {
                          id(RECIPE_WINE_VOLUME)[i] = 0;
                          id(RECIPE_TANK_ORDER)[i] = 0;
                        }
                    - lambda: |-
                        ESP_LOGI("recipe", "获取配方JSON...");
                        json::parse_json(body, [](JsonObject root) -> bool {
                          if (root["code"].as<int>() != 1) {
                            ESP_LOGW("recipe", "服务器返回无配方或错误");
                            // 只有在没有执行配方时才清空缓存
                            return false;
                          } else {
                            JsonArray result_index = root["data"]["result_index"];
                            JsonArray result = root["data"]["result"];
                            for (JsonObject item : result_index) {
                              for (JsonPair pair : item) {
                                ESP_LOGI("recipe", "result_index 水箱编号=%s, 容量=%.1f", pair.key().c_str(), pair.value().as<float>());
                              }
                            }
                            for (JsonObject item : result) {
                              for (JsonPair pair : item) {
                                ESP_LOGI("recipe", "酒配方: %s, 容量=%.1f", pair.key().c_str(), pair.value().as<float>());
                              }
                            }
                            int idx = 1;
                            for (JsonObject item : result_index) {
                              for (JsonPair pair : item) {
                                if (idx > 7) break;
                                int tank_num = atoi(pair.key().c_str());
                                float volume = pair.value().as<float>();
                                if (tank_num >= 1 && tank_num <= 8 && volume > 0.0f) {
                                  id(RECIPE_WINE_VOLUME)[idx-1] = volume;
                                  id(RECIPE_TANK_ORDER)[idx-1] = tank_num;
                                  idx++;
                                } else {
                                  ESP_LOGW("recipe", "忽略无效步骤: 水箱=%d, 体积=%.2f", tank_num, volume);
                                }
                              }
                            }
                            id(RECIPE_READY) = true;
                            return true;
                          }
                        });
                  else:
                    - logger.log:
                        format: "Error: Response status: %d, message %s"
                        args: [ 'response->status_code', 'body.c_str()' ]


          on_error:
            then:
              - logger.log: "Request failed!"
              # - button.press: restart_button

  # 打印并执行缓存步骤
  - id: make_recipe
    mode: single
    then:
      - if:
          condition:
            lambda: 'return id(RECIPE_READY) == true;'
          then:
            - repeat:
                count: !lambda "return sizeof(id(RECIPE_TANK_ORDER)) / sizeof(id(RECIPE_TANK_ORDER)[0]);"
                then:
                  - if: 
                      condition:
                        lambda: 'return id(RECIPE_TANK_ORDER)[iteration] > 0;'
                      then:
                        - logger.log:
                            format: "执行水箱: %d , 体积: %.1f"
                            args: [ 'id(RECIPE_TANK_ORDER)[iteration]', 'id(RECIPE_WINE_VOLUME)[iteration]' ]
                        - script.execute: 
                            id: pour_liquid
                            tank_num: !lambda "return id(RECIPE_TANK_ORDER)[iteration];"
                            volume: !lambda "return id(RECIPE_WINE_VOLUME)[iteration];"
                        - delay: 1s
            - wait_until:
                for:
                  time: 2s
                  condition:
                    lambda: 'return id(LIQUID_POURING) == false;'
            - lambda: |-
                id(RECIPE_READY) = false;

# =============================================================================
# 定时任务配置
# =============================================================================
interval:
  - interval: 6s
    then:
      - if:
          condition:
            or:
              - script.is_running: make_recipe
              - script.is_running: pour_liquid
              - switch.is_on: STOP_POST
          then:
            - logger.log: "配方或倒酒正在执行中，跳过定时获取;"
          else: 
            - script.execute: get_recipe
            - script.wait: get_recipe
            - script.execute: make_recipe
            - script.wait: make_recipe


